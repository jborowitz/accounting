name: Deploy Accounting Demo

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.VM_HOST }}" >> ~/.ssh/known_hosts

      - name: Sync Repo
        env:
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_USERNAME: ${{ secrets.VM_USERNAME }}
          VM_DEPLOY_PATH: ${{ secrets.VM_DEPLOY_PATH }}
        run: |
          DEPLOY_PATH="${VM_DEPLOY_PATH:-/home/$VM_USERNAME/accounting-demo}"
          echo "Deploy path: $DEPLOY_PATH"
          ssh -i ~/.ssh/deploy_key "$VM_USERNAME@$VM_HOST" "mkdir -p '$DEPLOY_PATH'"
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '.pytest_cache' \
            --exclude '.ruff_cache' \
            --exclude '.venv' \
            --exclude '*.pyc' \
            -e "ssh -i ~/.ssh/deploy_key" \
            ./ "$VM_USERNAME@$VM_HOST:$DEPLOY_PATH/"

      - name: Remote Deploy
        env:
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_USERNAME: ${{ secrets.VM_USERNAME }}
          VM_DEPLOY_PATH: ${{ secrets.VM_DEPLOY_PATH }}
        run: |
          DEPLOY_PATH="${VM_DEPLOY_PATH:-/home/$VM_USERNAME/accounting-demo}"
          ssh -i ~/.ssh/deploy_key "$VM_USERNAME@$VM_HOST" "DEPLOY_PATH='$DEPLOY_PATH' bash -s" << 'ENDSSH'
            set -e
            echo "Remote host: $(hostname)"
            echo "Remote user: $(whoami)"
            echo "Remote deploy path: ${DEPLOY_PATH}"
            cd "$DEPLOY_PATH"

            compose_cmd() {
              if docker compose version >/dev/null 2>&1; then
                docker compose "$@"
              elif command -v docker-compose >/dev/null 2>&1; then
                docker-compose "$@"
              else
                echo "Neither 'docker compose' nor 'docker-compose' is available"
                exit 1
              fi
            }

            docker --version
            compose_cmd -f docker-compose.demo.yml down || true
            compose_cmd -f docker-compose.demo.yml up -d --build
            compose_cmd -f docker-compose.demo.yml ps
            compose_cmd -f docker-compose.demo.yml logs --tail=80
          ENDSSH

      - name: API Smoke Tests
        env:
          HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
        run: |
          BASE="${HEALTHCHECK_URL:-https://jeffborowitz.com/accounting-demo}"
          BASE="${BASE%/}"
          echo "Waiting for container to be ready..."
          for i in 1 2 3 4 5; do
            if curl -fsSL --max-time 5 "$BASE/health" >/dev/null 2>&1; then
              echo "Container ready after attempt $i"
              break
            fi
            echo "Attempt $i failed, retrying in 3s..."
            sleep 3
          done
          echo "Health: $BASE/health"
          curl -fsSL "$BASE/health"
          echo
          echo "API health: $BASE/api/v1/health"
          curl -fsSL "$BASE/api/v1/health"
          echo
          echo "Demo summary: $BASE/api/v1/demo/summary"
          curl -fsSL "$BASE/api/v1/demo/summary"
          echo
          echo "Match summary: $BASE/api/v1/demo/match-summary"
          curl -fsSL "$BASE/api/v1/demo/match-summary"
          echo
          echo "Create match run: $BASE/api/v1/demo/match-runs"
          curl -fsSL -X POST "$BASE/api/v1/demo/match-runs"
          echo
          echo "Open exceptions: $BASE/api/v1/demo/exceptions?status=open&limit=5"
          curl -fsSL "$BASE/api/v1/demo/exceptions?status=open&limit=5"
          echo
          echo "Policy rules list: $BASE/api/v1/demo/rules/policy"
          curl -fsSL "$BASE/api/v1/demo/rules/policy?limit=5"
          echo
